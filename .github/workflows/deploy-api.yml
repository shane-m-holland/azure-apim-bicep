name: Deploy API to APIM (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (dev, staging, prod)'
        required: true
        type: string
      service-name:
        description: 'Name of the service/API being deployed'
        required: true
        type: string
      api-config-path:
        description: 'Path to API configuration file in service repository'
        type: string
        default: 'deployment/api-config.yml'
      api-spec-path:
        description: 'Path to API specification file in service repository'  
        type: string
        default: 'specs/api.openapi.yml'
      config-repo:
        description: 'Repository containing environment configurations'
        type: string
        default: ''
      config-path:
        description: 'Path to config files in config repository'
        type: string
        default: 'environments'
      apim-tooling-version:
        description: 'Version/ref of APIM tooling to use'
        type: string
        default: 'main'
      deployment-mode:
        description: 'Deployment mode (deploy, sync)'
        type: string
        default: 'sync'
      parallel-deployment:
        description: 'Deploy APIs in parallel'
        type: boolean
        default: true
      dry-run:
        description: 'Perform dry run only'
        type: boolean
        default: false
      use-spec-artifact:
        description: 'Use artifact instead of repository file for API specification'
        type: boolean
        default: false
      spec-artifact-name:
        description: 'Name of the artifact containing API specification'
        type: string
        default: 'api-specs'
      spec-artifact-path:
        description: 'Path within artifact to the specification file'
        type: string
        default: ''
      build-workflow-run-id:
        description: 'Run ID of workflow that generated the spec artifact (optional, uses current run if not specified)'
        type: string
        default: ''
    secrets:
      # AZURE_CREDENTIALS:
      #   description: 'Azure service principal credentials (JSON)'
      #   required: true
      CONFIG_REPO_TOKEN:
        description: 'GitHub token for accessing config repository'
        required: false

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Checkout APIM tooling repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/azure-apim-bicep
        ref: ${{ inputs.apim-tooling-version }}
        path: apim-tooling
        
    - name: Checkout config repository
      if: inputs.config-repo != ''
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.config-repo }}
        token: ${{ secrets.CONFIG_REPO_TOKEN || github.token }}
        path: config-repo
        
    - name: Checkout service repository
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ github.sha }}
        path: service-repo
        
    - name: Download API specification artifact
      if: inputs.use-spec-artifact == true
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.spec-artifact-name }}
        path: ./spec-artifact
        run-id: ${{ inputs.build-workflow-run-id != '' && inputs.build-workflow-run-id || github.run_id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Azure CLI
      uses: azure/CLI@v1
      with:
        inlineScript: |
          echo "Azure CLI is available"
        
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Install required tools
      run: |
        # Install jq for JSON processing
        sudo apt-get update && sudo apt-get install -y jq
        
        # Install yq for YAML processing
        pip install yq
        
        # Install xmllint for WSDL validation
        sudo apt-get install -y libxml2-utils
        
    - name: Setup deployment workspace
      working-directory: apim-tooling
      run: |
        echo "üîß Setting up deployment workspace for service: ${{ inputs.service-name }}"
        
        # Create environment directory
        mkdir -p environments/${{ inputs.environment }}
        mkdir -p specs/${{ inputs.environment }}
        
        # Copy environment configuration from config repo
        if [[ "${{ inputs.config-repo }}" != "" ]]; then
          CONFIG_FILE="../config-repo/${{ inputs.config-path }}/${{ inputs.environment }}/config.env"
          if [[ -f "$CONFIG_FILE" ]]; then
            cp "$CONFIG_FILE" "environments/${{ inputs.environment }}/config.env"
            echo "‚úÖ Copied environment config from config repository"
          else
            echo "‚ùå Config file not found: $CONFIG_FILE"
            exit 1
          fi
        else
          echo "‚ö†Ô∏è No config repository specified - using existing config.env"
        fi
        
        # Copy API configuration from service repo
        API_CONFIG="../service-repo/${{ inputs.api-config-path }}"
        if [[ -f "$API_CONFIG" ]]; then
          cp "$API_CONFIG" "environments/${{ inputs.environment }}/api-config.yml"
          echo "‚úÖ Copied API configuration from service repository"
        else
          echo "‚ùå API config file not found: $API_CONFIG"
          echo "Available files in service repo:"
          find ../service-repo -name "*.yml" -o -name "*.yaml" -o -name "*.json" | head -10
          exit 1
        fi
        
        # Copy API specification from artifact or service repo
        SPEC_FOUND=false
        
        if [[ "${{ inputs.use-spec-artifact }}" == "true" ]]; then
          echo "üì¶ Using API specification from artifact: ${{ inputs.spec-artifact-name }}"
          
          # Determine source path in artifact
          if [[ -n "${{ inputs.spec-artifact-path }}" ]]; then
            ARTIFACT_SPEC="../spec-artifact/${{ inputs.spec-artifact-path }}"
          else
            # Find spec file in artifact root
            ARTIFACT_SPEC=$(find ../spec-artifact -maxdepth 1 \( -name "*.json" -o -name "*.yaml" -o -name "*.yml" -o -name "*.wsdl" -o -name "*.xml" \) | head -1)
          fi
          
          if [[ -f "$ARTIFACT_SPEC" ]]; then
            # Determine spec file extension and copy appropriately
            SPEC_EXT="${ARTIFACT_SPEC##*.}"
            SPEC_FILENAME="${{ inputs.service-name }}.${SPEC_EXT}"
            cp "$ARTIFACT_SPEC" "specs/${{ inputs.environment }}/$SPEC_FILENAME"
            echo "‚úÖ Copied API specification from artifact: $SPEC_FILENAME"
            SPEC_FOUND=true
          else
            echo "‚ùå API specification not found in artifact: $ARTIFACT_SPEC"
            echo "Available files in artifact:"
            find ../spec-artifact -type f | head -10
          fi
        else
          echo "üìÅ Using API specification from service repository"
          API_SPEC="../service-repo/${{ inputs.api-spec-path }}"
          
          if [[ -f "$API_SPEC" ]]; then
            # Determine spec file extension and copy appropriately
            SPEC_EXT="${API_SPEC##*.}"
            SPEC_FILENAME="${{ inputs.service-name }}.${SPEC_EXT}"
            cp "$API_SPEC" "specs/${{ inputs.environment }}/$SPEC_FILENAME"
            echo "‚úÖ Copied API specification from repository: $SPEC_FILENAME"
            SPEC_FOUND=true
          else
            echo "‚ùå API specification file not found: $API_SPEC"
            echo "Available spec files in service repo:"
            find ../service-repo -name "*.openapi.*" -o -name "*.wsdl" -o -name "*.xml" | head -10
          fi
        fi
        
        # Validate that spec was found and copied
        if [[ "$SPEC_FOUND" != "true" ]]; then
          echo "‚ùå Failed to locate API specification"
          echo "Use-artifact mode: ${{ inputs.use-spec-artifact }}"
          echo "Expected artifact path: ${{ inputs.spec-artifact-path }}"
          echo "Expected repository path: ${{ inputs.api-spec-path }}"
          exit 1
        fi
        
        # Update API config to reference the correct spec path
        sed -i "s|specPath:.*|specPath: ./specs/${{ inputs.environment }}/$SPEC_FILENAME|g" \
          "environments/${{ inputs.environment }}/api-config.yml" || true
        
    - name: Validate deployment configuration
      working-directory: apim-tooling
      run: |
        echo "üîç Validating deployment configuration"
        chmod +x apim.sh scripts/*.sh
        
        # Validate environment and API configuration
        ./apim.sh validate ${{ inputs.environment }}
        
        # Display configuration summary
        echo ""
        echo "üìã Deployment Configuration Summary:"
        echo "Environment: ${{ inputs.environment }}"
        echo "Service: ${{ inputs.service-name }}"
        echo "Deployment Mode: ${{ inputs.deployment-mode }}"
        echo "Parallel Deployment: ${{ inputs.parallel-deployment }}"
        echo "Dry Run: ${{ inputs.dry-run }}"
        echo "Spec Source: ${{ inputs.use-spec-artifact == true && 'Artifact' || 'Repository' }}"
        if [[ "${{ inputs.use-spec-artifact }}" == "true" ]]; then
          echo "Artifact Name: ${{ inputs.spec-artifact-name }}"
          if [[ -n "${{ inputs.spec-artifact-path }}" ]]; then
            echo "Artifact Path: ${{ inputs.spec-artifact-path }}"
          fi
        else
          echo "Repository Path: ${{ inputs.api-spec-path }}"
        fi
        echo ""
        
    - name: Check API changes (for sync mode)
      if: inputs.deployment-mode == 'sync'
      working-directory: apim-tooling
      run: |
        echo "üîÑ Checking for API changes (sync mode)"
        # The sync command will automatically detect changes
        echo "Sync mode will deploy only changed APIs"
        
    - name: Deploy APIs (dry run)
      if: inputs.dry-run == true
      working-directory: apim-tooling
      run: |
        echo "üß™ Performing dry run API deployment"
        
        DEPLOY_CMD="./apim.sh deploy apis ${{ inputs.environment }} --dry-run"
        
        if [[ "${{ inputs.parallel-deployment }}" == "true" ]]; then
          DEPLOY_CMD="$DEPLOY_CMD --parallel"
        fi
        
        DEPLOY_CMD="$DEPLOY_CMD --verbose"
        
        echo "Executing: $DEPLOY_CMD"
        $DEPLOY_CMD
        
    - name: Deploy APIs  
      if: inputs.dry-run == false && inputs.deployment-mode == 'deploy'
      working-directory: apim-tooling
      run: |
        echo "üöÄ Deploying APIs to environment: ${{ inputs.environment }}"
        
        DEPLOY_CMD="./apim.sh deploy apis ${{ inputs.environment }}"
        
        if [[ "${{ inputs.parallel-deployment }}" == "true" ]]; then
          DEPLOY_CMD="$DEPLOY_CMD --parallel"
        fi
        
        DEPLOY_CMD="$DEPLOY_CMD --verbose"
        
        echo "Executing: $DEPLOY_CMD"
        $DEPLOY_CMD
        
    - name: Sync APIs (intelligent deployment)
      if: inputs.dry-run == false && inputs.deployment-mode == 'sync'
      working-directory: apim-tooling
      run: |
        echo "üîÑ Syncing APIs to environment: ${{ inputs.environment }}"
        
        SYNC_CMD="./apim.sh sync ${{ inputs.environment }} --debug"
        
        echo "Executing: $SYNC_CMD"
        $SYNC_CMD
        
    - name: Validate deployed APIs
      if: inputs.dry-run == false
      working-directory: apim-tooling
      run: |
        echo "‚úÖ Validating deployed APIs"
        
        # Source the environment config to get APIM details
        source "environments/${{ inputs.environment }}/config.env"
        
        # Check if APIs are accessible
        echo "Checking APIM instance: $APIM_NAME in resource group: $RESOURCE_GROUP"
        
        # List deployed APIs
        az apim api list \
          --service-name "$APIM_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --query '[].{Name:displayName, Path:path, Id:name}' \
          --output table || echo "‚ö†Ô∏è Could not retrieve API list"
          
    - name: Upload deployment artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-deployment-logs-${{ inputs.service-name }}-${{ inputs.environment }}-${{ github.run_number }}
        path: |
          apim-tooling/environments/${{ inputs.environment }}/api-config.yml
          apim-tooling/specs/${{ inputs.environment }}/
        retention-days: 30
        
    - name: Post-deployment summary
      if: always()
      run: |
        echo "## üöÄ API Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Service:** ${{ inputs.service-name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Mode:** ${{ inputs.deployment-mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**Spec Source:** ${{ inputs.use-spec-artifact == true && 'Artifact' || 'Repository' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Dry Run:** ${{ inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ job.status }}" == "success" ]]; then
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            echo "‚úÖ **Result:** Dry run validation completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Result:** API deployed successfully to APIM" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ùå **Result:** API deployment failed - check logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY